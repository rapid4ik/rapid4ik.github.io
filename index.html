<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>rapid4ik ‚Äî GitHub Portfolio</title>
  <meta name="description" content="–ù–µ–æ–Ω–æ–≤—ã–π –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ-—Å–∞–π—Ç —Å GitHub API: –ø—Ä–æ—Ñ–∏–ª—å, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, —è–∑—ã–∫–∏." />
  <meta name="theme-color" content="#05060a" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>
  <style>
    :root{
      --bg: #05060a;
      --panel: rgba(15,18,32,0.55);
      --glass: rgba(20,25,45,0.55);
      --text: #e6f1ff;
      --muted: #9fb3c8;
      --neon-pink: #ff2bd6;
      --neon-cyan: #00f0ff;
      --neon-purple:#9b5cff;
      --neon-green:#28f7a6;
      --card-radius: 18px;
      --shadow-neon: 0 0 12px rgba(0,240,255,.55), 0 0 24px rgba(155,92,255,.35);
      --ring: 0 0 0 2px rgba(0,240,255,.35), 0 0 24px rgba(155,92,255,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(255,43,214,.12), transparent 60%),
                  radial-gradient(1200px 800px at 80% 20%, rgba(0,240,255,.10), transparent 60%),
                  radial-gradient(1000px 700px at 50% 90%, rgba(155,92,255,.10), transparent 60%),
                  var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      line-height: 1.5;
      overflow-x: hidden;
    }
    .container{max-width:1200px;margin:0 auto;padding:32px 20px 80px}

    header{
      display:grid;grid-template-columns:120px 1fr;gap:24px;align-items:center;
      background: linear-gradient(180deg, rgba(0,240,255,.08), rgba(155,92,255,.06));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--card-radius);
      padding: 20px; backdrop-filter: blur(10px);
      box-shadow: var(--shadow-neon);
    }
    .avatar{
      width:110px;height:110px;border-radius:50%;object-fit:cover;border:2px solid rgba(0,240,255,.45);box-shadow:0 0 0 4px rgba(155,92,255,.15), 0 8px 30px rgba(0,0,0,.35)
    }
    .title{
      font-family: Orbitron, Inter, sans-serif;letter-spacing:.5px;
      font-size: clamp(24px, 3.4vw, 46px);
      font-weight: 800;
      margin: 0 0 4px;
      text-shadow: 0 0 8px rgba(0,240,255,.6), 0 0 18px rgba(255,43,214,.4);
    }
    .handle{color:var(--neon-cyan);font-family:Orbitron,Inter,sans-serif;font-weight:600}
    .bio{color:var(--muted);margin-top:6px}

    .cta-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .btn{
      appearance:none;border:none;cursor:pointer;position:relative;
      padding:10px 14px;border-radius:12px;font-weight:700;
      background: linear-gradient(90deg, rgba(0,240,255,.2), rgba(155,92,255,.2));
      color:var(--text);
      box-shadow: var(--shadow-neon);
      outline: none;
      transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
    }
    .btn:hover{transform: translateY(-1px);filter: brightness(1.08)}
    .btn:active{transform: translateY(0)}

    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:14px}
    .stat{
      border-radius:14px;background:var(--panel);backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,.06);padding:12px 14px;text-align:center
    }
    .stat .num{font-family:Orbitron,Inter,sans-serif;font-size:22px;font-weight:800}
    .stat .label{font-size:12px;color:var(--muted)}

    .section-title{margin:36px 0 12px;font-family:Orbitron,Inter,sans-serif;font-weight:800;letter-spacing:.4px}

    .panel{background:var(--glass);border:1px solid rgba(255,255,255,.06);border-radius:var(--card-radius);padding:18px;backdrop-filter:blur(8px);box-shadow: var(--shadow-neon)}

    #chartWrap{display:grid;grid-template-columns:1fr;gap:16px}
    #legend{display:flex;flex-wrap:wrap;gap:10px}
    .legend-item{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06)}
    .legend-dot{width:10px;height:10px;border-radius:50%}

    .toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:8px 0 14px;flex-wrap:wrap}
    .search{flex:1;position:relative;min-width:240px}
    .search input{width:100%;padding:12px 14px 12px 40px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.25);color:var(--text);outline:none;box-shadow: var(--ring)}
    .search svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.6}

    .repo-grid{display:grid;grid-template-columns:repeat( auto-fit, minmax(260px, 1fr) );gap:14px}
    .repo{position:relative;border-radius:16px;padding:16px;background:linear-gradient(180deg, rgba(0,240,255,.06), rgba(155,92,255,.06));border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(8px);cursor:pointer;transition: transform .15s ease, box-shadow .2s ease}
    .repo:hover{transform:translateY(-2px);box-shadow: var(--shadow-neon)}
    .repo h3{margin:0 0 6px;font-size:16px}
    .repo .desc{color:var(--muted);font-size:13px;min-height:38px}
    .repo .meta{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;font-size:12px;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}
    .langbar{margin-top:12px;height:8px;border-radius:999px;overflow:hidden;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08)}
    .langseg{height:100%}
    .repo-footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;font-size:12px;color:var(--muted)}

    .notice{padding:12px;border-radius:12px;background:rgba(255,255,255,.05);border:1px dashed rgba(255,255,255,.12);color:var(--muted)}
    .error{border-color: rgba(255, 71, 87, .5); color:#ff9fa8}

    footer{margin-top:40px;text-align:center;color:var(--muted);font-size:12px}

    /* ===== –ú–æ–¥–∞–ª —Ç–æ–∫–µ–Ω–∞ –∏ –∞–¥–∞–ø—Ç–∏–≤ ===== */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal-backdrop.open{display:flex}
    .modal{width:min(560px,92vw);background:var(--glass);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px;box-shadow:var(--shadow-neon)}
    .modal h3{margin:0 0 6px;font-family:Orbitron,Inter,sans-serif}
    .modal .muted{color:var(--muted);margin:0 0 10px}
    .modal .small{font-size:12px}
    .modal .row{display:flex;gap:10px}
    .modal input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:var(--text);outline:none}
    .modal .actions{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}

    @media (max-width: 420px){
      .container{padding:24px 14px 64px}
      header{grid-template-columns:68px 1fr;padding:14px}
      .avatar{width:64px;height:64px}
      .title{font-size:clamp(22px,6vw,34px)}
      .btn{padding:9px 12px}
      .repo{padding:14px}
      .stats{grid-template-columns:1fr 1fr;gap:8px}
    }
    @media (min-width: 1024px){
      .repo-grid{grid-template-columns:repeat(auto-fit, minmax(280px, 1fr))}
    }
    @media (min-width: 1400px){
      .container{max-width:1320px}
      .repo-grid{grid-template-columns:repeat(auto-fit, minmax(300px, 1fr))}
    }
    @media (hover: none){
      .btn:hover, .repo:hover{transform:none}
    }
    @media (prefers-reduced-motion: reduce){
      *{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important}
      header,.panel,.repo{box-shadow:none}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img id="avatar" class="avatar" alt="avatar" src="" loading="lazy" />
      <div>
        <h1 class="title"><span id="name">‚Ä¶</span> <span class="handle" id="handle"></span></h1>
        <p class="bio" id="bio"></p>
        <div class="cta-row">
          <a id="profileLink" class="btn" href="#" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å GitHub</a>
          <button id="copyLink" class="btn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∞–π—Ç">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
          <button id="tokenBtn" class="btn" title="–î–æ–±–∞–≤–∏—Ç—å/–æ—á–∏—Å—Ç–∏—Ç—å GitHub —Ç–æ–∫–µ–Ω">üîë –¢–æ–∫–µ–Ω</button>
        </div>
        <div class="stats" id="stats">
          <div class="stat"><div class="num" id="repoCount">‚Äî</div><div class="label">–ü—É–±–ª–∏—á–Ω—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏</div></div>
          <div class="stat"><div class="num" id="followers">‚Äî</div><div class="label">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</div></div>
          <div class="stat"><div class="num" id="following">‚Äî</div><div class="label">–ü–æ–¥–ø–∏—Å–∫–∏</div></div>
          <div class="stat"><div class="num" id="gists">‚Äî</div><div class="label">Gists</div></div>
        </div>
      </div>
    </header>

    <h2 class="section-title">–Ø–∑—ã–∫–∏ –≤ –ø—Ä–æ–µ–∫—Ç–∞—Ö</h2>
    <div class="panel" id="chartWrap">
      <div class="notice" id="chartNotice">–°–µ–∫—É–Ω–¥–æ—á–∫—É‚Ä¶ —Å–æ–±–∏—Ä–∞—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —è–∑—ã–∫–∞–º –≤–æ –≤—Å–µ—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö. –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥.</div>
      <canvas id="langChart" height="180" aria-label="–î–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —è–∑—ã–∫–æ–≤" role="img"></canvas>
      <div id="legend"></div>
    </div>

    <div class="toolbar">
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º‚Ä¶ (–∏–º—è, –æ–ø–∏—Å–∞–Ω–∏–µ, —è–∑—ã–∫)" />
      </div>
      <div class="pill" id="repoTotal">–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤: ‚Äî</div>
      <div class="pill" id="lastSync">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ‚Äî</div>
      <div class="pill" id="sourcePill">–ò—Å—Ç–æ—á–Ω–∏–∫: ‚Äî</div>
      <button class="btn" id="refreshBtn" title="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—á–∏—Ç–∞—Ç—å data/*.json">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <section class="repo-grid" id="repoGrid" aria-live="polite"></section>

    <div id="alerts" style="margin-top:16px"></div>

    <!-- Modal: GitHub Token -->
    <div id="tokenModal" class="modal-backdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="tokenTitle">
        <h3 id="tokenTitle">GitHub —Ç–æ–∫–µ–Ω</h3>
        <p class="muted">–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —É–≤–µ–ª–∏—á–∏—Ç –ª–∏–º–∏—Ç API –¥–æ ~5000 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å.</p>
        <div class="row"><input id="tokenInput" type="password" placeholder="ghp_... / github_pat_..." /></div>
        <div class="actions">
          <button id="tokenSave" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="tokenClear" class="btn">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button id="tokenClose" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <p class="muted small">–¢–æ–∫–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ (localStorage). –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ –µ–≥–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.</p>
      </div>
    </div>

    <footer>
      –°–¥–µ–ª–∞–Ω–æ —Å ‚ù§Ô∏è –∏ –Ω–µ–æ–Ω–æ–º ¬∑ –î–∞–Ω–Ω—ã–µ –∏–∑ <a href="https://docs.github.com/rest" target="_blank" rel="noopener">GitHub API</a> –∏–ª–∏ –∏–∑ <code>/data/*.json</code>
    </footer>
  </div>

  <script>
  // ====== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ======
  const USERNAME = new URL(location.href).searchParams.get('u') || 'rapid4ik';
  const GITHUB_TOKEN = null; // –∏–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Ç–æ–∫–µ–Ω–∞. –õ—É—á—à–µ —Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage.

  // –ù–µ–æ–Ω–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞
  const NEON_COLORS = [
    '#00f0ff', '#ff2bd6', '#9b5cff', '#28f7a6', '#ff9f1a', '#2ee6de', '#f368e0', '#54a0ff', '#ff6b6b', '#48dbfb', '#c56cf0', '#1dd1a1'
  ];

  let TOKEN = localStorage.getItem('gh_token') || GITHUB_TOKEN;

  // –†–µ–∂–∏–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ —á—Ç–µ–Ω–∏—è –≥–æ—Ç–æ–≤—ã—Ö JSON (–∫–æ—Ç–æ—Ä—ã–µ —Å–æ–±–∏—Ä–∞–µ—Ç GitHub Actions)
  const USE_JSON_FIRST = true;                 // —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º data/*.json
  const JSON_BASE = '/data';                   // –ø–∞–ø–∫–∞ —Å –≤—ã–≥—Ä—É–∑–∫–æ–π
  const JSON_CANDIDATES = [                    // –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –¥–ª—è –µ–¥–∏–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    `${JSON_BASE}/summary.json`,
    `${JSON_BASE}/data.json`,
    `${JSON_BASE}/github.json`,
    `${JSON_BASE}/out.json`
  ];
  const REFRESH_MS = 5 * 60 * 1000;            // –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
  let lastUpdatedAt = null;

  const getHeaders = () => {
    return TOKEN ? { 'Authorization': 'Bearer ' + TOKEN } : {};
  };

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const state = {
    profile: null,
    repos: [],
    filtered: [],
    langsByRepo: new Map(),
    langTotals: {},
    chart: null,
  };

  function fmt(n){
    return new Intl.NumberFormat('ru-RU').format(n);
  }
  function timeAgo(isoStr){
    const d = new Date(isoStr);
    const diff = (Date.now()-d)/1000;
    const units = [ ['–≥.',365*24*3600], ['–º–µ—Å.',30*24*3600], ['–¥.',24*3600], ['—á.',3600], ['–º–∏–Ω.',60] ];
    for(const [name,sec] of units){ if(diff>=sec) return Math.floor(diff/sec) + ' ' + name + ' –Ω–∞–∑–∞–¥'; }
    return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
  }

  async function ghFetch(url){
    const res = await fetch(url, { headers: { ...getHeaders(), 'Accept': 'application/vnd.github+json' } });
    if(res.status===403){
      const remaining = res.headers.get('X-RateLimit-Remaining');
      const reset = res.headers.get('X-RateLimit-Reset');
      const msg = remaining==='0'
        ? `–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç GitHub API. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ${reset?`, –∏–ª–∏ –ø–æ—Å–ª–µ ${new Date(+reset*1000).toLocaleTimeString('ru-RU')}`:''}.`
        : '–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω GitHub API.';
      throw new Error(msg);
    }
    if(!res.ok){
      const text = await res.text().catch(()=>res.statusText);
      throw new Error(text || res.statusText);
    }
    return { data: await res.json(), headers: res.headers };
  }

  // ===== –†–∞–±–æ—Ç–∞ —Å –≥–æ—Ç–æ–≤—ã–º–∏ JSON (Actions) =====
  async function fetchJSON(path){
    try{
      const r = await fetch(path + (path.includes('?')?'&':'?') + 't=' + Date.now(), { cache: 'no-store' });
      if(!r.ok) return null;
      return await r.json();
    }catch{ return null; }
  }

  function setLastSync(iso){
    lastUpdatedAt = iso;
    const el = $('#lastSync');
    if(el) el.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + (iso ? timeAgo(iso) : '‚Äî');
  }
  function setSource(src){
    const el = $('#sourcePill');
    if(el) el.textContent = '–ò—Å—Ç–æ—á–Ω–∏–∫: ' + src;
  }

  function renderRepos(repos){
    const grid = $('#repoGrid');
    grid.innerHTML = '';
    if(repos.length===0){
      grid.innerHTML = '<div class="notice">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ñ–∏–ª—å—Ç—Ä—É.</div>';
      return;
    }
    const frag = document.createDocumentFragment();
    for(const r of repos){
      const card = document.createElement('article');
      card.className = 'repo';
      card.innerHTML = `
        <h3>${r.name}</h3>
        <p class="desc">${r.description ? escapeHtml(r.description) : '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
        <div class="meta">
          <span class="pill" title="–û—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫">üß† ${r.language || '‚Äî'}</span>
          <span class="pill" title="‚≠ê Stars">‚≠ê ${fmt(r.stargazers_count || 0)}</span>
          <span class="pill" title="üç¥ Forks">üç¥ ${fmt(r.forks_count || 0)}</span>
        </div>
        <div class="langbar" aria-label="–î–æ–ª–∏ —è–∑—ã–∫–æ–≤ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏" role="img"></div>
        <div class="repo-footer">
          <span>–û–±–Ω–æ–≤–ª—ë–Ω: ${timeAgo(r.pushed_at || r.updated_at)}</span>
          <span>‚ñ∂Ô∏é</span>
        </div>
      `;
      card.addEventListener('click', ()=>window.open(r.html_url,'_blank','noopener'));
      card.dataset.fullName = r.full_name;
      frag.appendChild(card);
      const langs = r.languages || state.langsByRepo.get(r.full_name);
      if(langs) updateRepoLangBar(r.full_name, langs);
    }
    grid.appendChild(frag);
  }

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }

  function updateRepoLangBar(fullName, langs){
    const card = document.querySelector(\`.repo[data-full-name="\${CSS.escape(fullName)}"]\`);
    if(!card) return;
    const bar = card.querySelector('.langbar');
    const total = Object.values(langs||{}).reduce((a,b)=>a+b,0) || 0;
    bar.innerHTML = '';
    if(total===0) return;
    const entries = Object.entries(langs).sort((a,b)=>b[1]-a[1]).slice(0,6);
    entries.forEach(([lang, bytes], i)=>{
      const seg = document.createElement('div');
      seg.className = 'langseg';
      seg.style.width = (bytes*100/total).toFixed(2)+'%';
      seg.style.background = NEON_COLORS[i % NEON_COLORS.length];
      bar.appendChild(seg);
    });
  }

  function renderLangChart(){
    const totals = state.langTotals || {};
    const entries = Object.entries(totals).sort((a,b)=>b[1]-a[1]);
    if(entries.length===0) return;
    const top = entries.slice(0, 12);
    const other = entries.slice(12).reduce((acc,[,v])=>acc+v,0);
    const labels = top.map(([k])=>k);
    const data = top.map(([,v])=>v);
    if(other>0){ labels.push('Other'); data.push(other); }

    const ctx = $('#langChart').getContext('2d');
    if(state.chart){ state.chart.destroy(); }
    state.chart = new Chart(ctx, {
      type:'doughnut',
      data:{
        labels,
        datasets:[{
          data,
          backgroundColor: labels.map((_,i)=>NEON_COLORS[i%NEON_COLORS.length]),
          borderWidth: 0,
        }]
      },
      options:{
        responsive:true,
        plugins:{
          legend:{ display:false },
          tooltip:{ callbacks:{ label:(ctx)=> `${ctx.label}: ${fmt(ctx.parsed)} –±–∞–π—Ç` } }
        },
        cutout:'60%'
      }
    });

    const legend = $('#legend');
    legend.innerHTML = '';
    labels.forEach((label,i)=>{
      const el = document.createElement('div');
      el.className='legend-item';
      el.innerHTML = `<span class="legend-dot" style="background:${NEON_COLORS[i%NEON_COLORS.length]}"></span>${label}`;
      legend.appendChild(el);
    });
  }

  function renderAfterData(){
    $('#repoTotal').textContent = `–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤: ${fmt(state.repos.length)}`;
    renderRepos(state.filtered = state.repos);
    for(const r of state.repos){
      const langs = r.languages || state.langsByRepo.get(r.full_name);
      if(langs) updateRepoLangBar(r.full_name, langs);
    }
    $('#chartNotice').style.display='none';
    renderLangChart();
  }

  async function loadFromJSONCombinedOrSplit(showAlert=false){
    const alerts = $('#alerts');

    // 1) –ï–¥–∏–Ω—ã–π —Ñ–∞–π–ª
    for(const p of JSON_CANDIDATES){
      const pkg = await fetchJSON(p);
      if(pkg && (pkg.profile || pkg.user) && (pkg.repos || pkg.repositories)){
        const profile = pkg.profile || pkg.user;
        const repos   = pkg.repos || pkg.repositories;
        const totals  = pkg.langTotals || pkg.languages || {};
        const updated = pkg.updatedAt || pkg.generatedAt || pkg.updated || null;

        state.profile = profile;
        $('#avatar').src = profile.avatar_url;
        $('#name').textContent = profile.name || profile.login;
        $('#handle').textContent = '@'+profile.login;
        $('#bio').textContent = profile.bio || '';
        $('#profileLink').href = profile.html_url;
        $('#repoCount').textContent = fmt(profile.public_repos);
        $('#followers').textContent = fmt(profile.followers);
        $('#following').textContent = fmt(profile.following);
        $('#gists').textContent = fmt(profile.public_gists || 0);

        state.repos = repos;
        state.langTotals = totals;
        state.langsByRepo = new Map(repos.map(r=>[r.full_name, r.languages||{}]));

        renderAfterData();
        setLastSync((updated ? new Date(updated) : new Date()).toISOString());
        setSource('JSON (summary)');
        if(showAlert) alerts.innerHTML = `<div class="notice">–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ ${p}.</div>`;
        return true;
      }
    }

    // 2) –¢—Ä–∏ —Ñ–∞–π–ª–∞
    const profile = await fetchJSON(`${JSON_BASE}/profile.json`);
    const repos   = await fetchJSON(`${JSON_BASE}/repos.json`);
    const totals  = await fetchJSON(`${JSON_BASE}/langTotals.json`);
    if(profile && repos && totals){
      state.profile = profile;
      $('#avatar').src = profile.avatar_url;
      $('#name').textContent = profile.name || profile.login;
      $('#handle').textContent = '@'+profile.login;
      $('#bio').textContent = profile.bio || '';
      $('#profileLink').href = profile.html_url;
      $('#repoCount').textContent = fmt(profile.public_repos);
      $('#followers').textContent = fmt(profile.followers);
      $('#following').textContent = fmt(profile.following);
      $('#gists').textContent = fmt(profile.public_gists || 0);

      state.repos = repos;
      state.langTotals = totals;
      state.langsByRepo = new Map(repos.map(r=>[r.full_name, r.languages||{}]));

      renderAfterData();
      setLastSync(new Date().toISOString());
      setSource('JSON (split)');
      if(showAlert) alerts.innerHTML = '<div class="notice">–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ data/*.json.</div>';
      return true;
    } else {
      if(showAlert) alerts.innerHTML = '<div class="notice error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å data/*.json. –ò—Å–ø–æ–ª—å–∑—É—é –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ API.</div>';
      return false;
    }
  }

  async function loadProfile(){
    const { data } = await ghFetch(`https://api.github.com/users/${USERNAME}`);
    state.profile = data;
    $('#avatar').src = data.avatar_url;
    $('#name').textContent = data.name || data.login;
    $('#handle').textContent = '@'+data.login;
    $('#bio').textContent = data.bio || '';
    $('#profileLink').href = data.html_url;
    $('#repoCount').textContent = fmt(data.public_repos);
    $('#followers').textContent = fmt(data.followers);
    $('#following').textContent = fmt(data.following);
    $('#gists').textContent = fmt(data.public_gists || 0);
  }

  async function loadAllRepos(){
    const all = [];
    let page = 1;
    while(true){
      const { data, headers } = await ghFetch(`https://api.github.com/users/${USERNAME}/repos?per_page=100&sort=updated&direction=desc&page=${page}`);
      all.push(...data.filter(r=>!r.fork));
      const link = headers.get('Link')||'';
      if(!/rel="next"/.test(link)) break;
      page++;
    }
    all.sort((a,b)=> b.stargazers_count - a.stargazers_count || new Date(b.updated_at)-new Date(a.updated_at));
    state.repos = state.filtered = all;
    $('#repoTotal').textContent = `–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤: ${fmt(all.length)}`;
    renderRepos(all);
  }

  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞
  async function mapLimit(items, limit, worker){
    const ret = [];
    let i = 0; let active = 0;
    return new Promise((resolve, reject)=>{
      const next = ()=>{
        if(i===items.length && active===0) return resolve(ret);
        while(active<limit && i<items.length){
          const idx = i++; active++;
          Promise.resolve(worker(items[idx], idx)).then(v=>{ret[idx]=v; active--; next();}).catch(err=>reject(err));
        }
      };
      next();
    });
  }

  async function loadLanguagesForRepos(){
    const repos = state.repos;
    const alerts = $('#alerts');
    try{
      await mapLimit(repos, 4, async (r)=>{
        const { data } = await ghFetch(`https://api.github.com/repos/${r.full_name}/languages`);
        state.langsByRepo.set(r.full_name, data);
        for(const [lang, bytes] of Object.entries(data)){
          state.langTotals[lang] = (state.langTotals[lang]||0) + bytes;
        }
        updateRepoLangBar(r.full_name, data);
      });
      $('#chartNotice').style.display='none';
      renderLangChart();
    }catch(err){
      alerts.innerHTML = `<div class="notice error">${escapeHtml(String(err.message||err))}</div>`;
      $('#chartNotice').textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—É —è–∑—ã–∫–æ–≤.';
    }
  }

  function hookSearch(){
    $('#search').addEventListener('input', (e)=>{
      const q = e.target.value.toLowerCase().trim();
      if(!q){ state.filtered = state.repos; renderRepos(state.filtered); return; }
      state.filtered = state.repos.filter(r=>
        (r.name && r.name.toLowerCase().includes(q)) ||
        (r.description && r.description.toLowerCase().includes(q)) ||
        (r.language && (r.language.toLowerCase().includes(q)))
      );
      renderRepos(state.filtered);
      for(const r of state.filtered){
        const langs = r.languages || state.langsByRepo.get(r.full_name);
        if(langs) updateRepoLangBar(r.full_name, langs);
      }
    });
  }

  function hookCopy(){
    $('#copyLink').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(location.href); $('#copyLink').textContent='–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'; setTimeout(()=>$('#copyLink').textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É', 1500);}catch{alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å :(')}
    });
  }

  // –û–∫–Ω–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–º
  function hookToken(){
    const btn = $('#tokenBtn');
    const modal = $('#tokenModal');
    const input = $('#tokenInput');
    const save = $('#tokenSave');
    const clearBtn = $('#tokenClear');
    const close = $('#tokenClose');

    if(!btn) return;

    const open = () => { input.value = localStorage.getItem('gh_token') || ''; modal.classList.add('open'); setTimeout(()=>input.focus(), 0); };
    const hide = () => modal.classList.remove('open');

    btn.addEventListener('click', open);
    close.addEventListener('click', hide);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) hide(); });

    save.addEventListener('click', ()=>{
      const v = input.value.trim();
      if(!v){ alert('–í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –≤–∏–¥–∞ ghp_... / github_pat_...'); return; }
      localStorage.setItem('gh_token', v);
      TOKEN = v;
      hide();
      location.reload();
    });

    clearBtn.addEventListener('click', ()=>{
      localStorage.removeItem('gh_token');
      TOKEN = null;
      hide();
      location.reload();
    });
  }

  function hookRefresh(){
    const btn = $('#refreshBtn');
    if(!btn) return;
    btn.addEventListener('click', ()=> loadFromJSONCombinedOrSplit(true));
  }

  async function init(){
    try{
      const ok = USE_JSON_FIRST ? await loadFromJSONCombinedOrSplit(false) : false;
      hookSearch();
      hookCopy();
      hookToken();
      hookRefresh();

      if(!ok){
        await loadProfile();
        await loadAllRepos();
        loadLanguagesForRepos();
        setSource('API');
      } else {
        setInterval(()=> loadFromJSONCombinedOrSplit(true), REFRESH_MS);
      }
    }catch(err){
      $('#alerts').innerHTML = `<div class="notice error">${escapeHtml(String(err.message||err))}</div>`;
    }
  }

  init();
  </script>
</body>
</html>
